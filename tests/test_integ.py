# Integration tests for dashing
#
# Some tests are explicitly checking for broken outputs in order to spot unexpected changes
#
# debdeps: python3-pexpect python3-pyte python3-pytest

from __future__ import unicode_literals

import pyte
import pexpect


def run(w, h, path):
    screen = pyte.Screen(w, h)
    stream = pyte.ByteStream(screen)
    child = pexpect.spawn(path, dimensions=(h, w))
    child.expect(pexpect.EOF)
    stream.feed(child.before)
    out = screen.display
    child.terminate()
    return out


def check(out, exp):
    exp = [x.rstrip() for x in exp.splitlines()]
    out = [x.rstrip() for x in out]
    len_ok = len(out) == len(exp)

    if exp != out:
        print("-- out --")
        for line in out:
            print(line.rstrip())
        print("-- end out --")

    assert len_ok, f"Number of lines in output: {len(out)} != expected: {len(exp)}"
    assert out == exp


def test_basic_80_30():
    out = run(80, 30, "./tests/runner_1.py")
    exp = """\
   Dashing test run
┌ only title ─────────────────────────┐┌─────────────────────────────────────┐
│▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▌▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏││Hello World,                         │
└─────────────────────────────────────┘│this is dashing.                     │
┌─────────────────────────────────────┐│                                     │
│only label ▉▉▉▉▉▉▉▉▉▉▉▉▏▏▏▏▏▏▏▏▏▏▏▏▏▏│└─────────────────────────────────────┘
└─────────────────────────────────────┘┌ logs ───────────────────────────────┐
┌─────────────────────────────────────┐│0 -----                              │
│only label ▉▉▉▉▉▉▉▉▉▉▉▉▉▌▏▏▏▏▏▏▏▏▏▏▏▏││1 Hello                              │
└─────────────────────────────────────┘│2 -----                              │
┌─────────────────────────────────────┐└─────────────────────────────────────┘
│only label ▉▉▉▉▉▉▉▉▉▉▉▉▏▏▏▏▏▏▏▏▏▏▏▏▏▏│┌─────────────────────────────────────┐
└─────────────────────────────────────┘│                                     │
┌─────────────────────────────────────┐│                                     │
│only label ▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▎▏▏▏▏▏▏││                                     │
└─────────────────────────────────────┘└─────────────────────────────────────┘
▉▉▉▉▉▉▉▊▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏┌─────────────────────────────────────┐
▉▉▉▉▉▉▉▊▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏│                                     │
▉▉▉▉▉▉▉▊▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏│                                     │
                 ▉▉▉▉▉▉▉▉▉▉▉▏▏▏▏▏▏▏▏▏▏▏│                                     │
label, no border ▉▉▉▉▉▉▉▉▉▉▉▏▏▏▏▏▏▏▏▏▏▏└─────────────────────────────────────┘
                 ▉▉▉▉▉▉▉▉▉▉▉▏▏▏▏▏▏▏▏▏▏▏┌─────────────────────────────────────┐
┌───┐┌───┐┌───┐┌───┐┌───┐┌───┐┌───┐    │                                     │
│▄▄▄││███││███││▅▅▅││▁▁▁││▁▁▁││▃▃▃│    │                                     │
└───┘└───┘└───┘└───┘└───┘└───┘└───┘    │                                     │
                                       └─────────────────────────────────────┘



            """
    check(out, exp)


def test_basic_80_20():
    out = run(80, 20, "./tests/runner_1.py")
    exp = """\
   Dashing test run
┌ only title ─────────────────────────┐┌─────────────────────────────────────┐
└─────────────────────────────────────┘│this is dashing.                     │
┌─────────────────────────────────────┐└─────────────────────────────────────┘
└─────────────────────────────────────┘┌ logs ───────────────────────────────┐
┌─────────────────────────────────────┐│2 -----                              │
└─────────────────────────────────────┘└─────────────────────────────────────┘
┌─────────────────────────────────────┐┌─────────────────────────────────────┐
└─────────────────────────────────────┘│                                     │
┌─────────────────────────────────────┐└─────────────────────────────────────┘
└─────────────────────────────────────┘┌─────────────────────────────────────┐
▉▉▉▉▉▉▉▊▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏│                                     │
▉▉▉▉▉▉▉▊▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏└─────────────────────────────────────┘
                 ▉▉▉▉▉▉▉▉▉▉▉▏▏▏▏▏▏▏▏▏▏▏┌─────────────────────────────────────┐
label, no border ▉▉▉▉▉▉▉▉▉▉▉▏▏▏▏▏▏▏▏▏▏▏│                                     │
┌───┐┌───┐┌───┐┌───┐┌───┐┌───┐┌───┐    └─────────────────────────────────────┘
└───┘└───┘└───┘└───┘└───┘└───┘└───┘


            """
    check(out, exp)


def test_basic_100_50():
    out = run(100, 50, "./tests/runner_1.py")
    exp = """\
    Dashing test run
┌ only title ───────────────────────────────────┐┌───────────────────────────────────────────────┐
│▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▌▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏││Hello World,                                   │
│▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▌▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏││this is dashing.                               │
│▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▌▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏││                                               │
│▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▌▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏││                                               │
└───────────────────────────────────────────────┘│                                               │
┌───────────────────────────────────────────────┐│                                               │
│           ▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏││                                               │
│           ▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏│└───────────────────────────────────────────────┘
│only label ▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏│┌─  logs  ──────────────────────────────────────┐
│           ▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏││0 -----                                        │
└───────────────────────────────────────────────┘│1 Hello                                        │
┌───────────────────────────────────────────────┐│2 -----                                        │
│           ▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏││                                               │
│           ▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏││                                               │
│only label ▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏││                                               │
│           ▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏││                                               │
└───────────────────────────────────────────────┘└───────────────────────────────────────────────┘
┌───────────────────────────────────────────────┐┌───────────────────────────────────────────────┐
│           ▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏││                                               │
│           ▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏││                                               │
│only label ▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏││                                               │
│           ▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏││                                               │
└───────────────────────────────────────────────┘│                                               │
┌───────────────────────────────────────────────┐│                                               │
│           ▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▎▏▏▏▏▏▏▏▏││                                               │
│           ▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▎▏▏▏▏▏▏▏▏│└───────────────────────────────────────────────┘
│only label ▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▎▏▏▏▏▏▏▏▏│┌───────────────────────────────────────────────┐
│           ▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▎▏▏▏▏▏▏▏▏││                                               │
└───────────────────────────────────────────────┘│                                               │
▉▉▉▉▉▉▉▉▉▊▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏│                                               │
▉▉▉▉▉▉▉▉▉▊▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏│                                               │
▉▉▉▉▉▉▉▉▉▊▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏│                                               │
▉▉▉▉▉▉▉▉▉▊▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏│                                               │
▉▉▉▉▉▉▉▉▉▊▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏│                                               │
▉▉▉▉▉▉▉▉▉▊▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏└───────────────────────────────────────────────┘
                 ▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▌▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏┌───────────────────────────────────────────────┐
                 ▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▌▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏│                                               │
                 ▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▌▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏│                                               │
label, no border ▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▌▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏│                                               │
                 ▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▌▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏│                                               │
                 ▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▌▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏│                                               │
┌─────┐┌─────┐┌─────┐┌─────┐┌─────┐┌─────┐┌─────┐│                                               │
│     ││▆▆▆▆▆││▇▇▇▇▇││     ││     ││     ││     ││                                               │
│     ││█████││█████││▃▃▃▃▃││     ││     ││     │└───────────────────────────────────────────────┘
│█████││█████││█████││█████││     ││     ││▄▄▄▄▄│
│█████││█████││█████││█████││▄▄▄▄▄││▁▁▁▁▁││█████│
└─────┘└─────┘└─────┘└─────┘└─────┘└─────┘└─────┘
            """
    check(out, exp)


def test_basic_30_30():
    # FIXME: fix "this is dashing"
    out = run(30, 30, "./tests/runner_1.py")
    exp = """\
Dashing test run
┌only title──┐┌────────────┐
│▉▉▉▉▉▉▏▏▏▏▏▏││Hello World,│
└────────────┘│this is dashing
.────────────┐│            │
│only label ▋│└────────────┘
└────────────┘┌logs────────┐
┌────────────┐│0 -----     │
│only label ▋││1 Hello     │
└────────────┘│2 -----     │
┌────────────┐└────────────┘
│only label ▋│┌────────────┐
└────────────┘│            │
┌────────────┐│            │
│only label ▍││            │
└────────────┘└────────────┘
▉▉▊▏▏▏▏▏▏▏▏▏▏▏┌────────────┐
▉▉▊▏▏▏▏▏▏▏▏▏▏▏│            │
▉▉▊▏▏▏▏▏▏▏▏▏▏▏│            │
              │            │
label, no bord└────────────┘
              ┌────────────┐
┌┐┌┐┌┐┌┐┌┐┌┐┌┐│            │
│││││││││││││││            │
└┘└┘└┘└┘└┘└┘└┘│            │
              └────────────┘



            """
    check(out, exp)


def test_basic_80_18():
    # FIXME: broken alignment
    out = run(80, 18, "./tests/runner_1.py")
    exp = """\
┌─────────────────────────────────────┐
└─────────────────────────────────────┘┌─────────────────────────────────────┐
┌─────────────────────────────────────┐│this is dashing.                     │
└─────────────────────────────────────┘└─────────────────────────────────────┘
▉▉▉▉▉▉▉▊▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏┌ logs ───────────────────────────────┐
▉▉▉▉▉▉▉▊▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏│2 -----                              │
                 ▉▉▉▉▉▉▉▉▉▉▉▏▏▏▏▏▏▏▏▏▏▏└─────────────────────────────────────┘
label, no border ▉▉▉▉▉▉▉▉▉▉▉▏▏▏▏▏▏▏▏▏▏▏┌─────────────────────────────────────┐
┌───┐                                  │                                     │
└───┘┌───┐                             └─────────────────────────────────────┘
     └───┘┌───┐                        ┌─────────────────────────────────────┐
          └───┘┌───┐                   │                                     │
               └───┘┌───┐              └─────────────────────────────────────┘
                    └───┘┌───┐         ┌─────────────────────────────────────┐
                         └───┘┌───┐    │                                     │
                              └───┘    └─────────────────────────────────────┘

            """
    check(out, exp)


def test_basic_80_17():
    # FIXME: broken
    out = run(80, 17, "./tests/runner_1.py")
    exp = """\
   Dashing test run
┌ only title ─────────────────────────┐┌─────────────────────────────────────┐
┌─────────────────────────────────────┐│this is dashing.                     │
┌─────────────────────────────────────┐└─────────────────────────────────────┘
┌─────────────────────────────────────┐┌ logs ───────────────────────────────┐
┌─────────────────────────────────────┐│2 -----                              │
▉▉▉▉▉▉▉▊▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏▏└─────────────────────────────────────┘
label, no border ▉▉▉▉▉▉▉▉▉▉▉▏▏▏▏▏▏▏▏▏▏▏┌─────────────────────────────────────┐
┌───┐┌───┐┌───┐┌───┐┌───┐┌───┐┌───┐    │                                     │
                                       └─────────────────────────────────────┘
                                       ┌─────────────────────────────────────┐
                                       │                                     │
                                       └─────────────────────────────────────┘
                                       ┌─────────────────────────────────────┐
                                       │                                     │
                                       └─────────────────────────────────────┘
            """
    check(out, exp)
